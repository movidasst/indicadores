<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores de gestión de SST - Academia Movida</title>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'outfit': ['Outfit', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            dark: '#020617', 
                            primary: '#06b6d4', 
                            secondary: '#3b82f6', 
                            accent: '#8b5cf6' 
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- html2canvas & SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f8fafc; -webkit-print-color-adjust: exact; }
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; transition: all 0.2s; outline: none; font-family: 'Outfit', sans-serif; background-color: #ffffff; color: #0f172a; }
        .input-field:focus { border-color: #06b6d4; box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.15); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .break-inside-avoid { break-inside: avoid; }
            .shadow-sm, .shadow-lg, .shadow-xl { box-shadow: none !important; border: 1px solid #cbd5e1; }
        }
        
        /* Ocultar barra de desplazamiento en filtros */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- MANEJO SEGURO DE LOCALSTORAGE ---
        const safeJSONParse = (key, fallback) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : fallback;
            } catch (e) {
                console.error(`Error de integridad en localStorage [${key}]. Restaurando valores por defecto.`, e);
                return fallback;
            }
        };

        // --- BASE DE DATOS MAESTRA ---
        const DEFAULT_LIBRARY = [
            // VISION ZERO
            { id: 'VZ-1.1', source: 'Vision Zero', name: 'Compromiso Visible del Liderazgo', type: 'Proactivo', level: 'Estratégico', function: 'Liderazgo', unit: '%', calc: 'percentage', target: 80, desc: 'Mide qué tan activos son los jefes en terreno.', help: { what: 'Muestra si los gerentes realmente bajan a planta.', why: 'El ejemplo arrastra y muestra compromiso real.', labelNum: 'Visitas realizadas', labelDen: 'Visitas programadas', example: 'El gerente hizo 2 de 4 visitas mensuales.' } },
            { id: 'VZ-1.2', source: 'Vision Zero', name: 'Liderazgo Competente', type: 'Proactivo', level: 'Estratégico', function: 'Liderazgo', unit: '%', calc: 'percentage', target: 100, desc: 'Nuevos directivos con criterios SST.', help: { what: '% de jefes contratados evaluando sus competencias en seguridad.', why: 'Evita ingresar líderes que no valoran la prevención.', labelNum: 'Líderes evaluados en SST', labelDen: 'Total líderes contratados', example: 'Se contrataron 3 gerentes, a los 3 se les evaluó en SST.' } },
            { id: 'VZ-2.1', source: 'Vision Zero', name: 'Eficacia en Control de Riesgos', type: 'Proactivo', level: 'Táctico', function: 'Seguridad', unit: '%', calc: 'percentage', target: 90, desc: 'Verifica si los controles realmente funcionan.', help: { what: '% de medidas de control inspeccionadas que son efectivas.', why: 'Tener el control en papel no basta, debe funcionar en terreno.', labelNum: 'Controles efectivos', labelDen: 'Controles evaluados', example: 'De 10 guardas de seguridad revisadas, 9 funcionaban bien.' } },
            { id: 'VZ-2.2', source: 'Vision Zero', name: 'Aprendizaje de Eventos', type: 'Proactivo', level: 'Operativo', function: 'Seguridad', unit: '%', calc: 'percentage', target: 100, desc: 'Asegura que no solo investiguemos, sino que aprendamos.', help: { what: '% de accidentes con lección aprendida difundida.', why: 'Para que el mismo error no vuelva a ocurrir.', labelNum: 'Lecciones difundidas', labelDen: 'Total eventos', example: 'De 5 accidentes, difundimos 3 lecciones.' } },
            { id: 'VZ-3.1', source: 'Vision Zero', name: 'Cumplimiento de Metas SST', type: 'Proactivo', level: 'Estratégico', function: 'Gestión', unit: '%', calc: 'percentage', target: 90, desc: 'Avance del programa anual de SST.', help: { what: 'Progreso de los objetivos definidos a principio de año.', why: 'Mide si avanzamos según lo planeado.', labelNum: 'Metas cumplidas', labelDen: 'Metas planificadas', example: 'Cumplimos 8 de 10 actividades este mes.' } },
            { id: 'VZ-3.2', source: 'Vision Zero', name: 'Programas de Bienestar', type: 'Proactivo', level: 'Táctico', function: 'Bienestar', unit: '%', calc: 'percentage', target: 80, desc: 'Participación en iniciativas de salud y bienestar.', help: { what: '% de trabajadores participando en pausas activas o bienestar.', why: 'La salud integral previene fatiga y enfermedades.', labelNum: 'Trabajadores participantes', labelDen: 'Total trabajadores', example: '50 de 100 asistieron a la feria de salud.' } },
            { id: 'VZ-4.1', source: 'Vision Zero', name: 'Briefings Previos (Charla 5 min)', type: 'Proactivo', level: 'Operativo', function: 'Operación', unit: '%', calc: 'percentage', target: 95, desc: 'Verifica si los trabajos inician con seguridad.', help: { what: 'Tareas iniciadas con charla de seguridad.', why: 'Última barrera antes de exponerse al riesgo.', labelNum: 'Charlas realizadas', labelDen: 'Total trabajos', example: '18 charlas en 20 trabajos de alto riesgo.' } },
            { id: 'VZ-4.2', source: 'Vision Zero', name: 'SST en Planificación', type: 'Proactivo', level: 'Táctico', function: 'Operación', unit: '%', calc: 'percentage', target: 100, desc: 'Inclusión de SST antes de ejecutar proyectos.', help: { what: '% de nuevos proyectos que incluyeron revisión SST en su diseño.', why: 'Es más barato y seguro prevenir en el diseño que corregir operando.', labelNum: 'Proyectos con revisión SST', labelDen: 'Total proyectos nuevos', example: '4 de 4 proyectos pasaron por el comité SST.' } },
            { id: 'VZ-5.1', source: 'Vision Zero', name: 'Compras Seguras', type: 'Proactivo', level: 'Táctico', function: 'Adquisiciones', unit: '%', calc: 'percentage', target: 100, desc: 'Evaluación SST en compra de equipos/químicos.', help: { what: '% de compras de alto riesgo revisadas por SST.', why: 'Evita introducir nuevos peligros a la empresa.', labelNum: 'Compras aprobadas por SST', labelDen: 'Total compras críticas', example: 'Revisamos las fichas técnicas de 5 de 5 químicos comprados.' } },
            { id: 'VZ-5.2', source: 'Vision Zero', name: 'Inspecciones Pre-Uso', type: 'Proactivo', level: 'Operativo', function: 'Operación', unit: '%', calc: 'percentage', target: 95, desc: 'Revisión de maquinaria antes de operar.', help: { what: '% de equipos que completaron su checklist pre-uso.', why: 'Garantiza que la máquina no fallará y causará daño.', labelNum: 'Checklists completados', labelDen: 'Equipos en operación', example: '19 de 20 grúas hicieron su inspección matutina.' } },
            { id: 'VZ-6.1', source: 'Vision Zero', name: 'Cobertura de Inducción', type: 'Proactivo', level: 'Operativo', function: 'Capacitación', unit: '%', calc: 'percentage', target: 100, desc: 'Nuevos ingresos con inducción completa.', help: { what: '% de personal nuevo que recibió la inducción SST.', why: 'El personal nuevo es el más vulnerable a accidentes.', labelNum: 'Nuevos inducidos', labelDen: 'Total nuevos ingresos', example: 'Entraron 10 personas, capacitamos a 10.' } },
            { id: 'VZ-6.2', source: 'Vision Zero', name: 'Cumplimiento Plan Formación', type: 'Proactivo', level: 'Táctico', function: 'Capacitación', unit: '%', calc: 'percentage', target: 90, desc: 'Ejecución de la matriz de capacitación.', help: { what: 'Cursos realizados vs los programados en el mes.', why: 'Mantiene las competencias y la memoria de seguridad frescas.', labelNum: 'Horas/Cursos realizados', labelDen: 'Horas/Cursos programados', example: 'Dimos 3 de los 4 cursos programados este mes.' } },
            { id: 'VZ-7.1', source: 'Vision Zero', name: 'Sugerencias de Mejora', type: 'Proactivo', level: 'Operativo', function: 'Participación', unit: '#', calc: 'count', target: 10, desc: 'Ideas de seguridad aportadas por la base.', help: { what: 'Cantidad de ideas o sugerencias de mejora recibidas.', why: 'Los trabajadores son quienes mejor conocen los riesgos.', labelNum: 'N° de Sugerencias', labelDen: '-', example: 'Los operadores depositaron 12 ideas en el buzón.' } },
            { id: 'VZ-7.2', source: 'Vision Zero', name: 'Reconocimiento Positivo', type: 'Proactivo', level: 'Táctico', function: 'Liderazgo', unit: '%', calc: 'percentage', target: 50, desc: 'Refuerzo de comportamientos seguros.', help: { what: 'Proporción de inspecciones enfocadas en felicitar vs sancionar.', why: 'El refuerzo positivo construye mejor cultura que el castigo.', labelNum: 'Reconocimientos entregados', labelDen: 'Total inspecciones', example: 'En 10 rondas, felicitamos a 6 equipos por buen trabajo.' } },
            
            // ISO 45004
            { id: 'ISO-01', source: 'ISO 45004', name: 'Cumplimiento Legal', type: 'Proactivo', level: 'Estratégico', function: 'Legal', unit: '%', calc: 'percentage', target: 100, desc: 'Grado de apego a la ley local aplicable.', help: { what: 'Nuevas leyes o requisitos cumplidos vs los identificados.', why: 'Evita multas, paralizaciones y asegura lo mínimo exigible.', labelNum: 'Requisitos cumplidos', labelDen: 'Requisitos aplicables', example: 'Cumplimos 8 de 10 normas legales auditadas.' } },
            { id: 'ISO-02', source: 'ISO 45004', name: 'Participación en Comités', type: 'Proactivo', level: 'Táctico', function: 'Participación', unit: '%', calc: 'percentage', target: 100, desc: 'Asistencia y eficacia del Comité Paritario (COPASST/CSH).', help: { what: '% de asistencia a reuniones del comité de seguridad.', why: 'Garantiza la consulta y participación de los trabajadores.', labelNum: 'Miembros asistentes', labelDen: 'Total miembros', example: 'Asistieron 5 de 6 miembros a la reunión mensual.' } },
            { id: 'ISO-03', source: 'ISO 45004', name: 'Reporte de Casi Accidentes', type: 'Proactivo', level: 'Operativo', function: 'Seguridad', unit: '#', calc: 'count', target: 50, desc: 'Volumen de reportes preventivos (Near miss).', help: { what: 'Cantidad de reportes de peligro o actos inseguros recibidos.', why: 'Muchos reportes sin daño previenen el accidente grave.', labelNum: 'N° Reportes (Tarjetas)', labelDen: '-', example: 'Recibimos 45 tarjetas de observación este mes.' } },
            { id: 'ISO-04', source: 'ISO 45004', name: 'Eliminación de Peligros', type: 'Proactivo', level: 'Táctico', function: 'Seguridad', unit: '%', calc: 'percentage', target: 30, desc: 'Eficacia en erradicar riesgos desde la fuente.', help: { what: 'Peligros eliminados o sustituidos vs totales controlados.', why: 'Eliminar es mucho más efectivo que entregar equipos de protección.', labelNum: 'Peligros eliminados', labelDen: 'Total controles aplicados', example: 'De 10 mejoras, en 3 eliminamos la máquina ruidosa.' } },
            { id: 'ISO-05', source: 'ISO 45004', name: 'Exámenes Médicos (EMO)', type: 'Proactivo', level: 'Operativo', function: 'Salud', unit: '%', calc: 'percentage', target: 100, desc: 'Cumplimiento del programa de vigilancia médica.', help: { what: 'Exámenes médicos ocupacionales realizados vs programados.', why: 'Detecta a tiempo enfermedades relacionadas al trabajo.', labelNum: 'Exámenes realizados', labelDen: 'Exámenes programados', example: 'Evaluamos a 45 de los 50 trabajadores citados.' } },
            { id: 'ISO-06', source: 'ISO 45004', name: 'Cumplimiento Monitoreo Higiene', type: 'Proactivo', level: 'Táctico', function: 'Salud', unit: '%', calc: 'percentage', target: 100, desc: 'Ejecución de mediciones ambientales (ruido, polvo, etc.).', help: { what: 'Puntos de monitoreo evaluados según el plan.', why: 'Lo que no se mide no se puede controlar.', labelNum: 'Monitoreos realizados', labelDen: 'Monitoreos programados', example: 'Hicimos las 5 dosimetrías de ruido planeadas.' } },
            { id: 'ISO-07', source: 'ISO 45004', name: 'Cierre de Acciones Correctivas', type: 'Proactivo', level: 'Táctico', function: 'Mejora', unit: '%', calc: 'percentage', target: 90, desc: 'Velocidad de solución a hallazgos o no conformidades.', help: { what: 'Acciones correctivas cerradas en el plazo establecido.', why: 'Acumular problemas sin resolver aumenta la probabilidad de falla.', labelNum: 'Acciones cerradas a tiempo', labelDen: 'Total acciones venciendo', example: 'Cerramos 15 de 20 acciones pendientes este mes.' } },
            { id: 'ISO-08', source: 'ISO 45004', name: 'Tasa de Frecuencia (LTIFR)', type: 'Reactivo', level: 'Estratégico', function: 'Resultados', unit: 'IF', calc: 'rate', target: 2.5, desc: 'Índice de frecuencia de accidentes con tiempo perdido.', help: { what: 'Accidentes con baja multiplicados por la constante K (Horas).', why: 'Es el estándar internacional para comparar accidentabilidad.', labelNum: 'N° Accidentes con Baja', labelDen: 'Total Horas Trabajadas', example: '1 accidente en 200,000 horas. (El sistema calcula x K).' } },
            { id: 'ISO-09', source: 'ISO 45004', name: 'Tasa de Gravedad (LTISR)', type: 'Reactivo', level: 'Estratégico', function: 'Resultados', unit: 'IG', calc: 'rate', target: 20, desc: 'Índice de severidad o días perdidos.', help: { what: 'Días de incapacidad multiplicados por la constante K (Horas).', why: 'Muestra qué tan graves son las lesiones que están ocurriendo.', labelNum: 'Días Perdidos', labelDen: 'Total Horas Trabajadas', example: '15 días de incapacidad en 200,000 horas.' } },
            { id: 'ISO-10', source: 'ISO 45004', name: 'Eficacia de Simulacros', type: 'Proactivo', level: 'Operativo', function: 'Emergencias', unit: '%', calc: 'percentage', target: 90, desc: 'Ejecución y cumplimiento de objetivos en simulacros.', help: { what: 'Simulacros realizados cumpliendo el tiempo y estándar esperado.', why: 'Asegura estar listos ante un incendio, sismo u otra crisis.', labelNum: 'Simulacros exitosos', labelDen: 'Simulacros realizados', example: '2 de 2 simulacros evacuaron en menos de 3 minutos.' } },
            { id: 'ISO-11', source: 'ISO 45004', name: 'Ejecución de Auditorías', type: 'Proactivo', level: 'Táctico', function: 'Evaluación', unit: '%', calc: 'percentage', target: 100, desc: 'Avance del programa anual de auditorías.', help: { what: 'Auditorías internas y externas realizadas vs planificadas.', why: 'Garantiza la revisión periódica del sistema de gestión.', labelNum: 'Auditorías ejecutadas', labelDen: 'Auditorías programadas', example: 'Hicimos 1 de 1 auditoría programada este trimestre.' } },
            { id: 'ISO-12', source: 'ISO 45004', name: 'Clima / Cultura de Seguridad', type: 'Proactivo', level: 'Estratégico', function: 'Cultura', unit: 'Pts', calc: 'average', target: 85, desc: 'Puntuación de encuestas de percepción de seguridad.', help: { what: 'Promedio de calificación de los trabajadores sobre la seguridad.', why: 'La percepción subjetiva es un gran predictor de desempeño.', labelNum: 'Suma total de puntajes', labelDen: 'N° Encuestas tabuladas', example: '4250 puntos sumados entre 50 trabajadores encuestados.' } },
            { id: 'ISO-13', source: 'ISO 45004', name: 'Índice Enfermedad Profesional', type: 'Reactivo', level: 'Estratégico', function: 'Salud', unit: 'IEP', calc: 'rate', target: 0, desc: 'Tasa de enfermedades laborales diagnosticadas.', help: { what: 'Nuevas enfermedades ocupacionales por constante K.', why: 'Mide el impacto a largo plazo de las condiciones de trabajo.', labelNum: 'N° Casos de Enfermedad', labelDen: 'Total Horas Trabajadas', example: '0 casos diagnosticados este mes.' } },
            { id: 'ISO-14', source: 'ISO 45004', name: 'Investigaciones en Plazo', type: 'Proactivo', level: 'Táctico', function: 'Mejora', unit: '%', calc: 'percentage', target: 100, desc: 'Accidentes investigados dentro de las 48-72 hrs.', help: { what: 'Investigaciones terminadas dentro del plazo legal o interno.', why: 'La evidencia y los recuerdos se pierden si pasa mucho tiempo.', labelNum: 'Investigaciones a tiempo', labelDen: 'Total a investigar', example: 'De 2 incidentes, ambos se investigaron en menos de 48 hrs.' } },
            
            // NUEVOS INDICADORES AVANZADOS
            { id: 'ISO-15', source: 'ISO 45004', name: 'Índice de Incidencia', type: 'Reactivo', level: 'Estratégico', function: 'Resultados', unit: 'II', calc: 'incidence', target: 10, desc: 'Trabajadores accidentados por cada 1,000 expuestos.', help: { what: 'Mide la proporción de personas lesionadas físicamente.', why: 'Fácil de entender: "2 de cada 1000 se accidentaron".', labelNum: 'N° Accidentados', labelDen: 'Total Trabajadores', example: '2 accidentados en una plantilla de 500 = Indice de 4.0' } },
            { id: 'ISO-16', source: 'ISO 45004', name: 'Costos de Siniestralidad', type: 'Reactivo', level: 'Estratégico', function: 'Gestión', unit: '$', calc: 'currency', target: 1000, desc: 'Impacto económico de los accidentes y daños.', help: { what: 'Dinero real gastado por indemnizaciones, daños o paralización.', why: 'La alta gerencia entiende mejor cuando se habla de dinero.', labelNum: 'Monto Gastado ($)', labelDen: '-', example: '$1500 gastados en reparaciones y multas.' } },
            { id: 'ISO-17', source: 'ISO 45004', name: 'Variación de Accidentabilidad', type: 'Reactivo', level: 'Estratégico', function: 'Resultados', unit: '%', calc: 'variation', target: 0, desc: 'Tendencia de crecimiento o reducción de accidentes.', help: { what: 'Mide porcentualmente si aumentaron o bajaron los casos vs el periodo anterior.', why: 'Indica si estamos mejorando. Valores negativos son buenos.', labelNum: 'Accidentes Mes Actual', labelDen: 'Accidentes Mes Anterior', example: 'Tuvimos 8 (actual) vs 10 (anterior) = Variación de -20%' } },
            { id: 'ISO-18', source: 'ISO 45004', name: 'Cobertura de Prevencionistas', type: 'Proactivo', level: 'Táctico', function: 'Gestión', unit: 'Trab/Prev', calc: 'ratio', target: 50, desc: 'N° de trabajadores asignados por cada especialista SST.', help: { what: 'Indica si el equipo de seguridad está saturado.', why: 'Muchos trabajadores por prevencionista disminuye el control.', labelNum: 'N° de Prevencionistas', labelDen: 'Total Trabajadores', example: '2 Prevencionistas para 100 Trab = Ratio de 50 (1:50)' } }
        ];

        // --- ICONOS TECNOLÓGICOS ---
        const Icons = {
            Dashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9" rx="1" /><rect x="14" y="3" width="7" height="5" rx="1" /><rect x="14" y="12" width="7" height="9" rx="1" /><rect x="3" y="16" width="7" height="5" rx="1" /></svg>,
            Library: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            PlusCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
            Data: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/><ellipse cx="12" cy="5" rx="9" ry="3"/></svg>,
            Lightbulb: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 1 1 7.086 0l.607 1.274a3 3 0 0 1-2.693 4.19H10.535a3 3 0 0 1-2.693-4.19l.607-1.274z"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Play: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Refresh: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>,
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            ExternalLink: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            BookOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
        };

        const Card = ({ children, className = "", id }) => <div id={id} className={`bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden break-inside-avoid ${className}`}>{children}</div>;
        
        const Badge = ({ text, type }) => {
            const styles = {
                'Proactivo': 'bg-cyan-50 text-cyan-700 border-cyan-200',
                'Reactivo': 'bg-rose-50 text-rose-700 border-rose-200',
                'Estratégico': 'bg-indigo-50 text-indigo-700 border-indigo-200',
                'Táctico': 'bg-blue-50 text-blue-700 border-blue-200',
                'Operativo': 'bg-slate-100 text-slate-700 border-slate-200',
                'Personalizado': 'bg-amber-50 text-amber-700 border-amber-200'
            };
            return <span className={`px-2 py-0.5 rounded-md text-[10px] uppercase font-bold tracking-wider border ${styles[text] || styles['Operativo']}`}>{text}</span>;
        };

        // --- MOTOR GRÁFICO TOTALMENTE REDISEÑADO (Soporta valores negativos y 0 absoluto) ---
        const TrendChart = ({ data, target, type }) => {
            const height = 120; 
            const width = 320; 
            const paddingX = 25; 
            const paddingYTop = 35; 
            const paddingYBottom = 25; 
            
            const displayData = data && data.length > 0 ? data.slice(-12) : [];
            const hasData = displayData.length > 0;
            const values = hasData ? displayData.map(d => parseFloat(d.val)) : [];
            
            // Lógica robusta para mínimos (permite negativos) y máximos
            const targetVal = target !== undefined && target !== null && target !== '' ? parseFloat(target) : 0;
            const minRaw = Math.min(...(hasData ? values : [0]), targetVal, 0);
            const minVal = minRaw < 0 ? minRaw * 1.2 : 0; // Margen hacia abajo si hay negativos
            const maxVal = Math.max(...(hasData ? values : [0]), targetVal) * 1.2 || 5; 
            const range = maxVal - minVal;
            
            const calcY = (val) => height - paddingYBottom - (((val - minVal) / (range || 1)) * (height - paddingYTop - paddingYBottom));
            const calcX = (i) => values.length === 1 ? width / 2 : paddingX + (i * ((width - paddingX * 2) / (values.length - 1)));

            const targetY = target !== undefined && target !== null && target !== '' ? calcY(target) : null;
            const zeroY = calcY(0); // Línea del Eje X (puede estar más arriba si hay negativos)
            const lineColor = type === 'Reactivo' ? '#e11d48' : '#06b6d4'; 
            
            let points = "";
            if (hasData) {
                points = values.map((val, i) => `${calcX(i)},${calcY(val)}`).join(' ');
            }
            
            return (
                <div className="relative w-full h-32 bg-slate-50/50 rounded-xl overflow-hidden border border-slate-100 mt-2">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full overflow-visible">
                        {/* Línea base del Eje X (0 absoluto) */}
                        <line x1={paddingX} y1={zeroY} x2={width - paddingX} y2={zeroY} stroke="#cbd5e1" strokeWidth="1" />
                        
                        {/* Línea punteada de Meta integrada */}
                        {targetY !== null && (
                            <>
                                <line x1={0} y1={targetY} x2={width} y2={targetY} stroke="#f59e0b" strokeWidth="1.5" strokeDasharray="3,3" opacity="0.8"/>
                                <text x={width - paddingX + 15} y={targetY - 5} textAnchor="end" fontSize="8" fill="#f59e0b" fontWeight="bold">Meta: {target}</text>
                            </>
                        )}
                        
                        {hasData ? (
                            <>
                                {/* Sombreado dibuja desde el zeroY hacia el punto */}
                                <polygon points={`${values.length === 1 ? width/2 : paddingX},${zeroY} ${points} ${values.length === 1 ? width/2 : width-paddingX},${zeroY}`} fill={lineColor} fillOpacity="0.1" />
                                <polyline points={points} fill="none" stroke={lineColor} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" />
                                
                                {displayData.map((d, i) => {
                                    const val = parseFloat(d.val);
                                    const x = calcX(i);
                                    const y = calcY(val);
                                    const yearLabel = d.year ? ` ${d.year.toString().slice(-2)}` : '';
                                    
                                    const tooltipRectY = y < 30 ? y + 10 : y - 25;
                                    const tooltipTextY = y < 30 ? y + 21 : y - 14;

                                    return (
                                        <g key={i} className="group">
                                            {/* Etiqueta del Mes siempre abajo del gráfico, no atada al zeroY */}
                                            <text x={x} y={height - 8} fontSize="9" fill="#64748b" textAnchor="middle" fontWeight="bold" className="pointer-events-none">{d.month}{yearLabel}</text>
                                            <circle cx={x} cy={y} r="3.5" fill="white" stroke={lineColor} strokeWidth="2" className="transition-all cursor-pointer hover:stroke-4" />
                                            
                                            <rect x={x - 18} y={tooltipRectY} width="36" height="16" rx="4" fill="#0f172a" className="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none shadow-lg" />
                                            <text x={x} y={tooltipTextY} fontSize="9" fill="#ffffff" textAnchor="middle" fontWeight="bold" className="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">{val}</text>
                                        </g>
                                    );
                                })}
                            </>
                        ) : (
                            <text x="50%" y="50%" dominantBaseline="middle" textAnchor="middle" fill="#94a3b8" fontSize="12" fontFamily="sans-serif" fontWeight="bold">Esperando registros...</text>
                        )}
                    </svg>
                    {data && data.length > 12 && <div className="absolute bottom-1 right-2 text-[9px] text-slate-400 font-mono">Mostrando ult 12m</div>}
                </div>
            );
        };

        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [message]);

            if (!message) return null;
            return (
                <div className="fixed bottom-6 right-6 bg-slate-900 text-cyan-400 px-6 py-3 rounded-xl shadow-2xl shadow-cyan-900/20 z-50 animate-slide-up flex items-center gap-3 font-bold border border-slate-700">
                    <div><Icons.CheckCircle /></div> <span className="text-white">{message}</span>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('library');
            const [toastMsg, setToastMsg] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [showImportModal, setShowImportModal] = useState(false);
            
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: null, isAlert: false });
            const openConfirm = (title, message, onConfirm) => setModalConfig({ isOpen: true, title, message, onConfirm, isAlert: false });
            const openAlert = (title, message) => setModalConfig({ isOpen: true, title, message, onConfirm: null, isAlert: true });
            const closeModal = () => setModalConfig({ ...modalConfig, isOpen: false });

            const [editingRecord, setEditingRecord] = useState(null); 
            const [editingIndId, setEditingIndId] = useState(null);

            const [customLibrary, setCustomLibrary] = useState(() => safeJSONParse('iso45004_custom_v9', []));
            const [activeIds, setActiveIds] = useState(() => safeJSONParse('iso45004_active_ids_v9', []));
            const [records, setRecords] = useState(() => safeJSONParse('iso45004_records_v9', {}));
            const [kFactor, setKFactor] = useState(() => safeJSONParse('iso45004_kfactor_v9', 1000000));

            const fullLibrary = useMemo(() => [...DEFAULT_LIBRARY, ...customLibrary], [customLibrary]);
            const activeIndicators = useMemo(() => fullLibrary.filter(ind => activeIds.includes(ind.id)), [fullLibrary, activeIds]);

            useEffect(() => {
                localStorage.setItem('iso45004_custom_v9', JSON.stringify(customLibrary));
                localStorage.setItem('iso45004_active_ids_v9', JSON.stringify(activeIds));
                localStorage.setItem('iso45004_records_v9', JSON.stringify(records));
                localStorage.setItem('iso45004_kfactor_v9', JSON.stringify(kFactor));
            }, [customLibrary, activeIds, records, kFactor]);

            const showToast = (msg) => setToastMsg(msg);

            // --- 8 MÉTODOS DE CÁLCULO COMPLETOS ---
            const calculateValue = (method, num, den) => {
                const n = parseFloat(num) || 0;
                const d = parseFloat(den) || 0;

                if (method === 'percentage') {
                    if (d <= 0) return 0;
                    const val = (n / d) * 100;
                    return val > 100 ? "100.0" : val.toFixed(1);
                }
                if (method === 'rate') return d > 0 ? ((n / d) * kFactor).toFixed(2) : 0;
                if (method === 'incidence') return d > 0 ? ((n / d) * 1000).toFixed(2) : 0;
                if (method === 'average') return d > 0 ? (n / d).toFixed(1) : n;
                if (method === 'currency') return n.toFixed(2);
                if (method === 'variation') return d > 0 ? (((n - d) / d) * 100).toFixed(1) : (n > 0 ? "100.0" : "0.0");
                if (method === 'ratio') return n > 0 ? (d / n).toFixed(1) : 0;
                if (method === 'count') return n;
                return n;
            };

            const toggleIndicator = (id) => setActiveIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
            
            const addRecord = (indId, year, month, num, den, val, actionPlan, actionStatus = 'Abierto') => {
                const current = records[indId] || [];
                const periodId = `${year}-${month}`;
                const updated = [...current.filter(r => `${r.year}-${r.month}` !== periodId), { 
                    id: crypto.randomUUID(), year: parseInt(year), month, num, den, val, 
                    actionPlan, 
                    actionStatus: actionPlan ? actionStatus : null 
                }];
                
                const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                updated.sort((a,b) => {
                    if (a.year !== b.year) return a.year - b.year;
                    return months.indexOf(a.month) - months.indexOf(b.month);
                });
                
                setRecords({...records, [indId]: updated});
            };

            const handleUpdateRecord = (e) => {
                e.preventDefault();
                if (!editingRecord) return;
                
                const { indId, record } = editingRecord;
                const ind = fullLibrary.find(i => i.id === indId);
                if(!ind) return;

                const newVal = calculateValue(ind.calc, record.num, record.den);
                
                const currentRecs = records[indId] || [];
                const updatedRecs = currentRecs.map(r => {
                    if (r.id === record.id) {
                        return {
                            ...r,
                            num: parseFloat(record.num),
                            den: parseFloat(record.den),
                            val: newVal,
                            actionPlan: record.actionPlan,
                            actionStatus: record.actionPlan ? (r.actionStatus || 'Abierto') : null
                        };
                    }
                    return r;
                });
                
                setRecords({...records, [indId]: updatedRecs});
                setEditingRecord(null); 
                showToast("Registro actualizado exitosamente");
            };

            const toggleActionStatus = (indId, recordId) => {
                const updated = records[indId].map(r => {
                    if(r.id === recordId) {
                        return { ...r, actionStatus: r.actionStatus === 'Abierto' ? 'Cerrado' : 'Abierto' };
                    }
                    return r;
                });
                setRecords({...records, [indId]: updated});
                showToast("Estado de Acción Actualizado");
            };

            const handleDeleteRecord = (indId, recordId) => {
                openConfirm("Eliminar Registro", "¿Estás seguro de que deseas eliminar este registro? Esta acción no se puede deshacer.", () => {
                    const updated = records[indId].filter(r => r.id !== recordId);
                    setRecords({...records, [indId]: updated});
                    showToast("Registro eliminado");
                });
            };

            const exportExcel = () => {
                const exportData = [];
                Object.entries(records).forEach(([id, recs]) => {
                    const ind = fullLibrary.find(i => i.id === id) || { name: 'Desconocido', unit: '' };
                    recs.forEach(r => {
                        exportData.push({
                            "ID Indicador": id,
                            "Nombre del KPI": ind.name,
                            "Tipo": ind.type,
                            "Año": r.year,
                            "Mes": r.month,
                            "Numerador (Dato)": r.num,
                            "Denominador (Base)": r.den,
                            "Resultado Calculado": r.val,
                            "Unidad": ind.unit,
                            "Plan de Acción / Notas": r.actionPlan || '',
                            "Estado PHVA": r.actionStatus || 'N/A' 
                        });
                    });
                });

                if (exportData.length === 0) {
                    openAlert("Sin Datos", "No hay registros en el historial para exportar.");
                    return;
                }
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Historial_SST");
                XLSX.writeFile(workbook, `ISO45004_Dashboard_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast("Archivo Excel descargado con éxito");
            };

            const downloadTemplate = () => {
                const templateData = [
                    { "ID Indicador": "VZ-1.1", "Año": 2024, "Mes": "Ene", "Numerador (Dato)": 3, "Denominador (Base)": 4, "Plan de Acción / Notas": "Faltó una visita, reprogramada.", "Estado PHVA (Abierto/Cerrado)": "Abierto" }
                ];
                const ws1 = XLSX.utils.json_to_sheet(templateData);

                const refData = fullLibrary.map(ind => ({ "ID Indicador": ind.id, "Nombre de Indicador": ind.name, "Tipo": ind.type, "Nivel": ind.level }));
                const ws2 = XLSX.utils.json_to_sheet(refData);

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws1, "Importar_Datos");
                XLSX.utils.book_append_sheet(wb, ws2, "Catálogo_Codigos_ID");

                XLSX.writeFile(wb, "Plantilla_Importacion_SST.xlsx");
                showToast("Plantilla descargada");
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = new Uint8Array(evt.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const wsname = workbook.SheetNames[0]; 
                        const ws = workbook.Sheets[wsname];
                        const rows = XLSX.utils.sheet_to_json(ws);
                        
                        let newRecords = { ...records };
                        let importedCount = 0;
                        let newActiveIdsSet = new Set(activeIds);

                        rows.forEach(row => {
                            const id = row["ID Indicador"];
                            const year = row["Año"];
                            const month = row["Mes"];
                            const num = row["Numerador (Dato)"];
                            const den = row["Denominador (Base)"] || 0;
                            const actionPlan = row["Plan de Acción / Notas"] || "";
                            const rawStatus = row["Estado PHVA (Abierto/Cerrado)"] || "";
                            const actionStatus = rawStatus.toLowerCase() === 'cerrado' ? 'Cerrado' : (actionPlan ? 'Abierto' : null);

                            if (id && year && month && num !== undefined) {
                                const ind = fullLibrary.find(i => i.id === id);
                                if (ind) {
                                    const val = calculateValue(ind.calc, num, den);
                                    const current = newRecords[id] || [];
                                    const periodId = `${year}-${month}`;
                                    
                                    const updated = current.filter(r => `${r.year}-${r.month}` !== periodId);
                                    updated.push({ id: crypto.randomUUID(), year: parseInt(year), month: month, num: parseFloat(num), den: parseFloat(den), val: val, actionPlan: actionPlan, actionStatus: actionStatus });
                                    
                                    const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                                    updated.sort((a,b) => {
                                        if (a.year !== b.year) return a.year - b.year;
                                        return months.indexOf(a.month) - months.indexOf(b.month);
                                    });
                                    
                                    newRecords[id] = updated;
                                    newActiveIdsSet.add(id); 
                                    importedCount++;
                                }
                            }
                        });

                        setRecords(newRecords);
                        setActiveIds(Array.from(newActiveIdsSet));
                        setShowImportModal(false);
                        
                        if (importedCount > 0) {
                            showToast(`✅ Se importaron ${importedCount} registros correctamente.`);
                        } else {
                            openAlert("Sin Datos", "No se encontró ningún registro válido para importar. Verifica las columnas.");
                        }

                    } catch (err) {
                        console.error(err);
                        openAlert("Error de Lectura", "Hubo un problema procesando el archivo Excel.");
                    }
                    e.target.value = null; 
                };
                reader.readAsArrayBuffer(file);
            };

            const loadDemoData = () => {
                openConfirm("Cargar Demo Completo", "¿Reemplazar tus datos con la demostración de los 8 tipos de indicadores y fórmulas avanzadas?", () => {
                    const demoIds = ['VZ-1.1', 'VZ-4.1', 'ISO-07', 'ISO-08', 'ISO-15', 'ISO-16', 'ISO-17', 'ISO-18'];
                    setActiveIds(demoIds);
                    const currYear = new Date().getFullYear();
                    
                    const mockRecords = {
                        'VZ-1.1': [ // %
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 3, den: 4, val: 75, actionPlan: 'Faltó 1 visita por viaje gerencial.', actionStatus: 'Cerrado' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 4, den: 4, val: 100, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 4, den: 4, val: 100, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 5, den: 4, val: 100, actionPlan: '', actionStatus: null }
                        ],
                        'VZ-4.1': [ // %
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 15, den: 20, val: 75, actionPlan: 'Supervisores olvidan registro.', actionStatus: 'Cerrado' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 18, den: 20, val: 90, actionPlan: 'Mejora progresiva.', actionStatus: 'Abierto' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 19, den: 20, val: 95, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 20, den: 20, val: 100, actionPlan: '', actionStatus: null }
                        ],
                        'ISO-07': [ // %
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 10, den: 10, val: 100, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 12, den: 15, val: 80, actionPlan: 'Retraso de proveedores en EPP.', actionStatus: 'Abierto' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 15, den: 15, val: 100, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 8, den: 8, val: 100, actionPlan: '', actionStatus: null }
                        ],
                        'ISO-08': [ // Factor K
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 0, den: 200000, val: 0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 0, den: 200000, val: 0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 1, den: 200000, val: 5.0, actionPlan: 'Accidente corte mano. Parada de planta.', actionStatus: 'Abierto' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 0, den: 200000, val: 0, actionPlan: '', actionStatus: null }
                        ],
                        'ISO-15': [ // Incidencia
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 2, den: 500, val: 4.0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 6, den: 500, val: 12.0, actionPlan: 'Brote de accidentes en almacén.', actionStatus: 'Abierto' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 1, den: 500, val: 2.0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 0, den: 500, val: 0, actionPlan: '', actionStatus: null }
                        ],
                        'ISO-16': [ // Costos / Moneda
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 500, den: 0, val: 500.0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 1500, den: 0, val: 1500.0, actionPlan: 'Gastos superaron meta por indemnización.', actionStatus: 'Cerrado' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 200, den: 0, val: 200.0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 0, den: 0, val: 0, actionPlan: '', actionStatus: null }
                        ],
                        'ISO-17': [ // Variación Porcentual
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 10, den: 12, val: -16.7, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 15, den: 10, val: 50.0, actionPlan: 'Aumento del 50% vs mes anterior.', actionStatus: 'Abierto' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 8, den: 15, val: -46.7, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 5, den: 8, val: -37.5, actionPlan: '', actionStatus: null }
                        ],
                        'ISO-18': [ // Ratio
                            { id: crypto.randomUUID(), year: currYear, month: 'Ene', num: 2, den: 120, val: 60.0, actionPlan: 'Faltan especialistas. Relación 1 a 60.', actionStatus: 'Cerrado' },
                            { id: crypto.randomUUID(), year: currYear, month: 'Feb', num: 3, den: 120, val: 40.0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Mar', num: 3, den: 120, val: 40.0, actionPlan: '', actionStatus: null },
                            { id: crypto.randomUUID(), year: currYear, month: 'Abr', num: 4, den: 125, val: 31.3, actionPlan: '', actionStatus: null }
                        ]
                    };

                    setRecords(mockRecords);
                    setKFactor(1000000); 
                    setView('dashboard'); 
                    showToast("✅ Base de datos Demo Avanzada cargada");
                });
            };

            const resetData = () => {
                openConfirm("Borrar Todo", "⚠️ PELIGRO: ¿Estás seguro de borrar TODOS los datos? Esta acción no se puede deshacer.", () => {
                    setActiveIds([]);
                    setRecords({});
                    setCustomLibrary([]);
                    setView('library');
                    showToast("🗑️ Sistema reiniciado correctamente");
                });
            };

            // --- VISTAS ---
            
            const EditRecordModal = () => {
                if (!editingRecord) return null;
                const { indId, record } = editingRecord;
                const ind = fullLibrary.find(i => i.id === indId);
                const help = ind?.help || { labelNum: 'Valor (A)', labelDen: 'Total (B)' };

                return (
                    <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[70] flex items-center justify-center p-4 animate-fade-in">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl shadow-cyan-900/20 p-6 w-full max-w-md text-white max-h-[90vh] overflow-y-auto">
                            <h2 className="text-xl font-bold mb-1 flex items-center gap-2 text-cyan-400"><Icons.Edit/> Editar Registro</h2>
                            <p className="text-sm text-slate-400 mb-5">{ind.name} <span className="text-cyan-400 ml-1 font-mono">({record.month} {record.year})</span></p>
                            
                            <form onSubmit={handleUpdateRecord} className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-400 block mb-1">A. {help.labelNum}</label>
                                    <input type="number" step="0.01" required className="input-field bg-slate-800 border-slate-600 text-white focus:border-cyan-500 font-mono" 
                                        value={record.num} onChange={e => setEditingRecord({...editingRecord, record: {...record, num: e.target.value}})} />
                                </div>
                                {ind.calc !== 'count' && ind.calc !== 'currency' && (
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 block mb-1">B. {help.labelDen}</label>
                                        <input type="number" step="0.01" required className="input-field bg-slate-800 border-slate-600 text-white focus:border-cyan-500 font-mono" 
                                            value={record.den} onChange={e => setEditingRecord({...editingRecord, record: {...record, den: e.target.value}})} />
                                    </div>
                                )}
                                
                                {ind.calc === 'percentage' && parseFloat(record.num) > parseFloat(record.den) && parseFloat(record.den) > 0 && (
                                    <div className="text-xs text-emerald-400 bg-emerald-900/30 p-2 rounded border border-emerald-800/50">
                                        Has superado lo planeado. El cumplimiento se ajustará al 100%.
                                    </div>
                                )}

                                <div>
                                    <label className="text-xs font-bold text-slate-400 block mb-1">Plan de Acción / Notas (Opcional si cumple meta)</label>
                                    <textarea className="input-field bg-slate-800 border-slate-600 text-white focus:border-cyan-500 text-sm" rows="3" 
                                        value={record.actionPlan || ''} onChange={e => setEditingRecord({...editingRecord, record: {...record, actionPlan: e.target.value}})}></textarea>
                                </div>
                                
                                <div className="mt-6 flex justify-end gap-3 pt-4 border-t border-slate-700">
                                    <button type="button" onClick={() => setEditingRecord(null)} className="px-5 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl font-bold transition-colors w-full">Cancelar</button>
                                    <button type="submit" className="px-5 py-2.5 rounded-xl font-bold transition-colors w-full text-white bg-cyan-600 hover:bg-cyan-500 shadow-lg shadow-cyan-600/30">Guardar Cambios</button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            };

            const SettingsModal = () => {
                if (!showSettings) return null;
                return (
                    <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl shadow-cyan-900/20 p-6 w-full max-w-md text-white">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-cyan-400"><Icons.Settings/> Configuración Global</h2>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-300 mb-2">Constante 'K' (Cálculo de Tasas)</label>
                                    <p className="text-xs text-slate-500 mb-2">Define la base matemática para índices como el LTIFR.</p>
                                    <select className="input-field bg-slate-800 text-white border-slate-600 focus:border-cyan-500" value={kFactor} onChange={e => setKFactor(Number(e.target.value))}>
                                        <option value={1000000}>1,000,000 (Estándar ISO/Europeo)</option>
                                        <option value={200000}>200,000 (Estándar OSHA/Americano)</option>
                                    </select>
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button onClick={() => setShowSettings(false)} className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-bold transition-colors">Guardar y Cerrar</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const ImportModal = () => {
                if (!showImportModal) return null;
                return (
                    <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl shadow-cyan-900/20 p-6 w-full max-w-md text-white max-h-[90vh] overflow-y-auto">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-cyan-400"><Icons.Upload/> Importación Masiva (Excel)</h2>
                            <div className="space-y-5">
                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                    <h3 className="font-bold text-sm mb-2 text-cyan-300 flex items-center gap-2">Paso 1: La Plantilla</h3>
                                    <p className="text-xs text-slate-400 mb-3">Descarga nuestro formato exacto. No cambies los nombres de las columnas. Incluye una pestaña con los "Códigos ID" requeridos.</p>
                                    <div className="bg-cyan-900/30 border border-cyan-800/50 p-3 rounded-lg mb-4 text-xs text-cyan-100 flex items-start gap-2">
                                        <div className="text-cyan-400 shrink-0"><Icons.Lightbulb /></div>
                                        <p><strong>¿Indicador Nuevo?</strong> Créalo primero en la app (botón "Crear Propio"). Al descargar la plantilla, su nuevo ID autogenerado aparecerá en la segunda hoja.</p>
                                    </div>
                                    <button onClick={downloadTemplate} className="w-full py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-bold transition-colors flex items-center justify-center gap-2"><Icons.Download /> Descargar Formato (.xlsx)</button>
                                </div>
                                <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                    <h3 className="font-bold text-sm mb-2 text-cyan-300 flex items-center gap-2">Paso 2: Subir Datos</h3>
                                    <p className="text-xs text-slate-400 mb-3">Una vez llena tu plantilla, cárgala aquí. El sistema calculará y acomodará los meses automáticamente.</p>
                                    <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="block w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-cyan-600 file:text-white hover:file:bg-cyan-500 cursor-pointer"/>
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button onClick={() => setShowImportModal(false)} className="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white border border-slate-600 rounded-lg font-bold transition-colors">Cancelar</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const InputView = () => {
                if (activeIndicators.length === 0) return (
                    <div className="flex flex-col items-center justify-center py-20 bg-white rounded-3xl border border-dashed border-slate-300 shadow-sm mx-4">
                        <div className="bg-cyan-50 text-cyan-500 p-5 rounded-full mb-4"><Icons.Library /></div>
                        <h3 className="text-xl font-bold text-slate-800 mb-2 text-center">Aún no hay indicadores activos</h3>
                        <p className="text-slate-500 mb-6 text-center max-w-md">Para ingresar datos, primero debes seleccionar los KPIs que deseas medir desde el catálogo o importar tu archivo Excel directamente.</p>
                        <div className="flex flex-col sm:flex-row gap-4">
                            <button onClick={() => setView('library')} className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-bold shadow-lg shadow-cyan-500/30 transition-all flex items-center justify-center gap-2">Ir al Catálogo</button>
                            <button onClick={() => setShowImportModal(true)} className="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold shadow-sm border border-slate-300 transition-all flex items-center justify-center gap-2"><Icons.Upload /> Importar Excel</button>
                        </div>
                    </div>
                );

                const currentYear = new Date().getFullYear();
                const [selectedId, setSelectedId] = useState(activeIndicators[0]?.id || '');
                const [year, setYear] = useState(currentYear);
                const [month, setMonth] = useState('Ene');
                const [num, setNum] = useState('');
                const [den, setDen] = useState('');
                const [actionPlan, setActionPlan] = useState('');

                const yearOptions = [2024, 2025, 2026, 2027, 2028, 2029, 2030];
                const currentInd = activeIndicators.find(i => i.id === selectedId) || activeIndicators[0];
                const help = currentInd?.help || { labelNum: 'Valor', labelDen: 'Total', what: 'Sin ayuda', why: '-', example: '-' };
                
                useEffect(() => { setNum(''); setDen(''); setActionPlan(''); }, [selectedId]);

                const simulated = calculateValue(currentInd?.calc, num, den);
                const isTargetMet = currentInd.type === 'Reactivo' ? Number(simulated) <= Number(currentInd.target) : Number(simulated) >= Number(currentInd.target);
                const requiresAction = num !== '' && !isTargetMet;

                const handleSave = (e) => {
                    e.preventDefault();
                    if (!currentInd) return;
                    if (requiresAction && !actionPlan.trim()) {
                        openAlert("Acción Requerida", "La meta no se cumplió. Es obligatorio ingresar un Plan de Acción (PHVA).");
                        return;
                    }
                    addRecord(currentInd.id, year, month, num, den, simulated, actionPlan, 'Abierto');
                    showToast("Registro manual guardado exitosamente");
                    setNum(''); setDen(''); setActionPlan('');
                };

                return (
                    <div className="animate-fade-in grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <div className="lg:col-span-7 space-y-6">
                            <Card className="p-6 md:p-8 border-t-4 border-t-cyan-500">
                                <h2 className="text-xl md:text-2xl font-bold text-slate-800 mb-6">Registrar Medición Mensual</h2>
                                <form onSubmit={handleSave} className="space-y-6">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase">Indicador Seleccionado</label>
                                        <select className="input-field font-bold bg-slate-50 mt-1" value={selectedId} onChange={e=>setSelectedId(e.target.value)}>{activeIndicators.map(i=><option key={i.id} value={i.id}>{i.name}</option>)}</select>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Año</label>
                                            <select className="input-field bg-slate-50 mt-1" value={year} onChange={e=>setYear(Number(e.target.value))}>
                                                {yearOptions.map(y=><option key={y} value={y}>{y}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-500 uppercase">Mes</label>
                                            <select className="input-field bg-slate-50 mt-1" value={month} onChange={e=>setMonth(e.target.value)}>{['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'].map(m=><option key={m} value={m}>{m}</option>)}</select>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-5 md:p-6 rounded-2xl border border-slate-200 space-y-4 shadow-inner">
                                        <div>
                                            <label className="text-sm font-bold text-slate-700 block mb-1 flex justify-between"><span>A. {help.labelNum}</span></label>
                                            <input type="number" step="0.01" required className="input-field text-lg font-mono bg-white shadow-sm" value={num} onChange={e=>setNum(e.target.value)} placeholder="0" />
                                        </div>
                                        
                                        {/* Solo mostrar denominador B si la fórmula lo requiere */}
                                        {currentInd.calc !== 'count' && currentInd.calc !== 'currency' && <div>
                                            <label className="text-sm font-bold text-slate-700 block mb-1 flex justify-between"><span>B. {help.labelDen}</span></label>
                                            <input type="number" step="0.01" required className="input-field text-lg font-mono bg-white shadow-sm" value={den} onChange={e=>setDen(e.target.value)} placeholder="0" />
                                        </div>}
                                        
                                        {currentInd.calc === 'percentage' && parseFloat(num) > parseFloat(den) && parseFloat(den) > 0 && (
                                            <div className="text-xs text-emerald-600 bg-emerald-50 p-3 rounded-lg border border-emerald-200 flex items-start gap-2">
                                                <div className="shrink-0"><Icons.CheckCircle /></div>
                                                <p><strong>¡Superaste lo planeado!</strong> Matemáticamente el cumplimiento se limitará al <strong>100%</strong> para no distorsionar tus estadísticas y promedios.</p>
                                            </div>
                                        )}

                                        <div className="pt-4 border-t border-slate-200 mt-4 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 text-sm font-mono bg-slate-900 text-white p-4 rounded-xl shadow-lg">
                                            <span className="text-slate-300">Valor Calculado:</span>
                                            <span className={`font-bold text-xl ${num ? (isTargetMet ? 'text-emerald-400' : 'text-rose-400') : 'text-slate-500'}`}>
                                                {simulated} <span className="text-sm font-normal">{currentInd.unit}</span>
                                                <span className="text-xs text-slate-400 ml-2">(Meta: {currentInd.target})</span>
                                            </span>
                                        </div>
                                    </div>

                                    <div className={`p-5 rounded-2xl border transition-colors ${requiresAction ? 'bg-rose-50 border-rose-200' : 'bg-slate-50 border-slate-200'}`}>
                                        <label className={`text-sm font-bold flex items-center gap-2 mb-2 ${requiresAction ? 'text-rose-800' : 'text-slate-700'}`}>
                                            {requiresAction ? <><Icons.AlertCircle /> Plan de Acción Obligatorio (PHVA)</> : <><Icons.Lightbulb /> Notas / Comentarios (Opcional)</>}
                                        </label>
                                        {requiresAction && <p className="text-xs text-rose-600 mb-3">La meta no se cumplió. La norma exige documentar una acción correctiva. Esta nacerá en estado <strong className="uppercase">"Abierto"</strong>.</p>}
                                        <textarea required={requiresAction} placeholder={requiresAction ? "Describa el plan de acción responsable y fecha..." : "Añade un comentario, justificación o contexto a este resultado..."} className={`input-field text-sm bg-white ${requiresAction ? 'border-rose-300 focus:border-rose-500 focus:ring-rose-500/20' : 'border-slate-300 focus:border-cyan-500'}`} rows="3" value={actionPlan} onChange={e=>setActionPlan(e.target.value)}></textarea>
                                    </div>

                                    <button type="submit" className="w-full py-4 bg-gradient-to-r from-cyan-600 to-blue-600 text-white rounded-xl font-bold shadow-lg shadow-cyan-500/30 hover:scale-[1.02] transition-all">Guardar Dato Manual</button>
                                </form>
                            </Card>
                        </div>
                        <div className="lg:col-span-5 space-y-6">
                            <Card className="bg-slate-900 text-white p-6 sticky top-6 border-none shadow-2xl shadow-cyan-900/20">
                                <h3 className="font-bold text-lg mb-1 flex items-center gap-2 text-cyan-400"><Icons.Lightbulb/> Ayuda Didáctica</h3>
                                <p className="text-slate-400 text-sm mb-6 font-mono">{currentInd.id} • {currentInd.type}</p>
                                <div className="space-y-4">
                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700"><p className="text-xs font-bold text-cyan-300 uppercase mb-1">¿Qué es?</p><p className="text-sm text-slate-200">{help.what}</p></div>
                                    <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700"><p className="text-xs font-bold text-cyan-300 uppercase mb-1">¿Por qué importa?</p><p className="text-sm text-slate-200">{help.why}</p></div>
                                    <div className="bg-cyan-950/30 p-4 rounded-xl border border-cyan-800/50"><p className="text-xs font-bold text-cyan-400 uppercase mb-1">Ejemplo Práctico</p><p className="text-sm italic text-cyan-100">"{help.example}"</p></div>
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            };

            const DashboardView = () => {
                const [dashFilter, setDashFilter] = useState('ALL'); 

                if (activeIndicators.length === 0) return (
                    <div className="flex flex-col items-center justify-center py-20 bg-white rounded-3xl border border-dashed border-slate-300 shadow-sm mx-4">
                        <div className="bg-cyan-50 text-cyan-500 p-5 rounded-full mb-4"><Icons.Dashboard /></div>
                        <h3 className="text-xl font-bold text-slate-800 mb-2 text-center">Tablero de Control Vacío</h3>
                        <p className="text-slate-500 mb-6 text-center max-w-md">Tu tablero está listo para mostrar gráficas. Puedes empezar seleccionando indicadores en el Catálogo o importando tus datos históricos desde Excel.</p>
                        <div className="flex flex-col sm:flex-row gap-4">
                            <button onClick={() => setView('library')} className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-bold shadow-lg shadow-cyan-500/30 transition-all flex items-center justify-center gap-2">Ir al Catálogo</button>
                            <button onClick={() => setShowImportModal(true)} className="px-6 py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl font-bold shadow-sm border border-slate-300 transition-all flex items-center justify-center gap-2"><Icons.Upload /> Importar Excel</button>
                        </div>
                    </div>
                );
                
                const downloadCardAsPNG = (id, name) => {
                    const element = document.getElementById(`card-${id}`);
                    if (element && window.html2canvas) {
                        window.html2canvas(element, { scale: 2, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `KPI_${id}_${name.replace(/\s+/g, '_')}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                            showToast(`Imagen exportada a PNG`);
                        }).catch(err => {
                            console.error("Error al exportar PNG:", err);
                            showToast("Error al exportar la imagen");
                        });
                    }
                };

                const filteredDashIndicators = activeIndicators.filter(ind => {
                    if (dashFilter === 'ALL') return true;
                    if (dashFilter === 'PRO') return ind.type === 'Proactivo';
                    if (dashFilter === 'REA') return ind.type === 'Reactivo';
                    if (dashFilter === 'ALERT') {
                        const recs = records[ind.id] || [];
                        return recs.some(r => r.actionStatus === 'Abierto');
                    }
                    return true;
                });

                return (
                    <div className="animate-fade-in space-y-6">
                        <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center bg-white p-5 rounded-xl shadow-sm border border-slate-200 no-print gap-4">
                            <div>
                                <h2 className="font-bold text-xl text-slate-900">Panel de Resultados Tecnológicos</h2>
                                <p className="text-sm text-slate-500 font-mono">Monitoreo en tiempo real de KPIs</p>
                            </div>
                            
                            <div className="flex bg-slate-100 p-1 rounded-lg w-full lg:w-auto overflow-x-auto no-scrollbar">
                                <button onClick={() => setDashFilter('ALL')} className={`px-4 py-2 text-sm font-bold rounded-md whitespace-nowrap transition-colors ${dashFilter === 'ALL' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>Todos</button>
                                <button onClick={() => setDashFilter('PRO')} className={`px-4 py-2 text-sm font-bold rounded-md whitespace-nowrap transition-colors ${dashFilter === 'PRO' ? 'bg-cyan-100 text-cyan-700' : 'text-slate-500'}`}>Proactivos</button>
                                <button onClick={() => setDashFilter('REA')} className={`px-4 py-2 text-sm font-bold rounded-md whitespace-nowrap transition-colors ${dashFilter === 'REA' ? 'bg-rose-100 text-rose-700' : 'text-slate-500'}`}>Reactivos</button>
                                <button onClick={() => setDashFilter('ALERT')} className={`px-4 py-2 text-sm font-bold rounded-md whitespace-nowrap transition-colors flex items-center gap-1 ${dashFilter === 'ALERT' ? 'bg-amber-100 text-amber-700' : 'text-slate-500'}`}><Icons.AlertCircle/> Alertas</button>
                            </div>

                            <div className="flex flex-wrap gap-2 w-full lg:w-auto">
                                <button onClick={() => setShowImportModal(true)} className="flex flex-1 items-center justify-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2.5 rounded-lg font-bold text-sm shadow-sm transition-colors border border-slate-300"><Icons.Upload/> Importar</button>
                                <button onClick={exportExcel} className="flex flex-1 items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-lg font-bold text-sm shadow-lg transition-colors"><Icons.Download/> Excel</button>
                            </div>
                        </div>

                        {filteredDashIndicators.length === 0 ? (
                            <div className="text-center py-10 text-slate-400">No hay indicadores que coincidan con este filtro.</div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                                {filteredDashIndicators.map(ind => {
                                    const data = records[ind.id] || [];
                                    const lastRec = data.length ? data[data.length-1] : null;
                                    const lastVal = lastRec ? lastRec.val : '-';
                                    let isGood = null;
                                    if (lastRec) { isGood = ind.type === 'Reactivo' ? Number(lastVal) <= Number(ind.target) : Number(lastVal) >= Number(ind.target); }
                                    
                                    const openActions = data.filter(r => r.actionStatus === 'Abierto');

                                    return (
                                        <Card key={ind.id} id={`card-${ind.id}`} className={`p-6 hover:shadow-lg transition-shadow flex flex-col justify-between border-t-4 ${openActions.length > 0 ? 'border-t-rose-500' : 'border-t-slate-800'} relative group`}>
                                            <button data-html2canvas-ignore="true" onClick={() => downloadCardAsPNG(ind.id, ind.name)} title="Descargar como PNG" className="absolute top-4 right-4 p-2 bg-slate-100 hover:bg-cyan-100 text-slate-400 hover:text-cyan-600 rounded-lg opacity-0 group-hover:opacity-100 transition-all z-10 shadow-sm"><Icons.Camera /></button>

                                            <div>
                                                <div className="mb-4 pr-8">
                                                    <div className="mb-2">
                                                        <Badge text={ind.type} type={ind.type}/>
                                                    </div>
                                                    <h3 className="font-bold text-slate-900 text-lg sm:text-xl leading-snug break-words">{ind.name}</h3>
                                                </div>
                                                
                                                <div className="text-left mb-2">
                                                    <div className={`text-3xl font-extrabold font-mono flex items-center gap-1 tracking-tighter ${isGood === true ? 'text-emerald-500' : isGood === false ? 'text-rose-500' : 'text-slate-800'}`}>
                                                        {lastVal}
                                                        <span className="text-sm text-slate-400 font-sans tracking-normal">{ind.unit}</span>
                                                    </div>
                                                    {isGood !== null && (
                                                        <div className="flex items-center gap-1 mt-1">
                                                            {isGood ? <span className="text-emerald-500 flex items-center text-xs font-bold gap-1"><Icons.CheckCircle/> En Meta</span> : <span className="text-rose-500 flex items-center text-xs font-bold gap-1"><Icons.AlertCircle/> Alerta</span>}
                                                        </div>
                                                    )}
                                                </div>

                                                <TrendChart data={data} target={ind.target} type={ind.type} />
                                            </div>
                                            
                                            <div className="mt-5 pt-4 border-t border-slate-100 text-xs text-slate-500 space-y-3">
                                                <div className="flex justify-between font-mono bg-slate-100 px-3 py-1.5 rounded-lg">
                                                    <span className="font-bold text-slate-700">Meta obj: {ind.target}</span>
                                                    <span>Data: {data.length} pts</span>
                                                </div>
                                                {openActions.length > 0 && (
                                                    <div className="bg-rose-50 text-rose-800 p-3 rounded-lg border border-rose-200">
                                                        <span className="font-bold text-rose-900 flex items-center gap-1 mb-1"><Icons.AlertCircle/> {openActions.length} PHVA Pendiente(s):</span> 
                                                        <span className="italic break-words">{openActions[openActions.length-1].actionPlan}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </Card>
                                    )
                                })}
                            </div>
                        )}
                        
                        <Card className="mt-8 no-print border-slate-200 shadow-sm">
                            <div className="p-5 border-b border-slate-100 font-bold text-slate-900 flex items-center gap-2">
                                <Icons.Data /> Historial de Registro y Cierre de PHVA
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm min-w-[800px]">
                                    <thead className="bg-slate-50 font-bold text-slate-500 uppercase text-xs">
                                        <tr>
                                            <th className="p-4 border-b border-slate-200 whitespace-nowrap">Indicador (KPI)</th>
                                            <th className="p-4 border-b border-slate-200">Periodo</th>
                                            <th className="p-4 border-b border-slate-200 text-right">Resultado</th>
                                            <th className="p-4 border-b border-slate-200">Plan de Acción / Notas</th>
                                            <th className="p-4 border-b border-slate-200 text-center">Estado Acción</th>
                                            <th className="p-4 border-b border-slate-200 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {Object.entries(records).flatMap(([id, recs]) => recs.map(r => ({...r, indId: id})))
                                            .sort((a,b) => {
                                                if (b.year !== a.year) return b.year - a.year;
                                                const monthList = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
                                                return monthList.indexOf(b.month) - monthList.indexOf(a.month);
                                            })
                                            .slice(0, 25)
                                            .map((rec) => {
                                                const ind = fullLibrary.find(i => i.id === rec.indId) || {};
                                                return (
                                                    <tr key={rec.id} className="hover:bg-cyan-50/30 transition-colors">
                                                        <td className="p-4 font-bold text-slate-800 max-w-[200px] truncate" title={ind.name}>{ind.name}</td>
                                                        <td className="p-4 text-slate-500 font-mono bg-slate-50 w-24 text-center whitespace-nowrap">{rec.month} {rec.year}</td>
                                                        <td className="p-4 text-right font-mono font-bold text-cyan-600 whitespace-nowrap">{rec.val} <span className="text-slate-400 text-xs">{ind.unit}</span></td>
                                                        <td className="p-4 text-slate-600 italic text-xs max-w-xs truncate" title={rec.actionPlan}>{rec.actionPlan || <span className="text-slate-300">N/A</span>}</td>
                                                        
                                                        <td className="p-4 text-center">
                                                            {rec.actionStatus ? (
                                                                <button 
                                                                    onClick={() => toggleActionStatus(rec.indId, rec.id)}
                                                                    className={`px-3 py-1 rounded-full text-xs font-bold shadow-sm transition-colors border whitespace-nowrap ${rec.actionStatus === 'Abierto' ? 'bg-rose-100 text-rose-700 border-rose-300 hover:bg-rose-200' : 'bg-emerald-100 text-emerald-700 border-emerald-300 hover:bg-emerald-200'}`}
                                                                >
                                                                    {rec.actionStatus === 'Abierto' ? '🔴 Abierto' : '✅ Cerrado'}
                                                                </button>
                                                            ) : (
                                                                <span className="text-slate-300">-</span>
                                                            )}
                                                        </td>
                                                        
                                                        <td className="p-4 text-right flex items-center justify-end gap-3">
                                                            <button onClick={() => setEditingRecord({indId: rec.indId, record: {...rec}})} className="text-slate-400 hover:text-cyan-500 transition-colors" title="Editar"><Icons.Edit/></button>
                                                            <button onClick={() => handleDeleteRecord(rec.indId, rec.id)} className="text-slate-400 hover:text-rose-500 transition-colors" title="Eliminar"><Icons.Trash/></button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        {Object.keys(records).length === 0 && (
                                            <tr>
                                                <td colSpan="6" className="p-8 text-center text-slate-400 italic">No hay registros en el historial todavía.</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    </div>
                );
            };

            const LibraryView = () => {
                const [searchTerm, setSearchTerm] = useState('');
                const filtered = fullLibrary.filter(ind => ind.name.toLowerCase().includes(searchTerm.toLowerCase()));
                
                const deleteCustom = (e, id) => {
                    e.stopPropagation();
                    openConfirm("Eliminar Indicador", "¿Seguro que deseas eliminar este indicador personalizado? Se borrarán sus datos históricos también.", () => {
                        setCustomLibrary(customLibrary.filter(i=>i.id !== id));
                        setActiveIds(activeIds.filter(i=>i !== id));
                        const newRecs = {...records}; delete newRecs[id]; setRecords(newRecs);
                        showToast("Indicador eliminado");
                    });
                };

                const editCustomIndicator = (e, ind) => {
                    e.stopPropagation();
                    setEditingIndId(ind.id);
                    setView('create');
                };

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="bg-gradient-to-br from-slate-900 to-slate-800 text-white p-6 md:p-8 rounded-3xl shadow-2xl shadow-slate-900/20 relative overflow-hidden flex flex-col md:flex-row justify-between items-start md:items-end border border-slate-700 gap-4">
                            <div className="relative z-10">
                                <h2 className="text-2xl md:text-3xl font-bold mb-2 text-white">Catálogo de Indicadores</h2>
                                <p className="text-slate-300 max-w-lg text-sm md:text-base">Selecciona qué medir en tu sistema de gestión. Usa "Crear Propio" si necesitas KPIs específicos.</p>
                            </div>
                            <div className="relative z-10 flex flex-col sm:flex-row gap-2 w-full md:w-auto mt-2 md:mt-0">
                                <input className="bg-slate-800/80 border border-slate-600 text-white px-4 py-2.5 rounded-lg outline-none backdrop-blur-sm focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 placeholder-slate-400 w-full sm:w-auto" placeholder="Buscar..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                <button onClick={() => setView('create')} className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2.5 rounded-lg font-bold shadow-lg shadow-cyan-500/30 flex items-center justify-center gap-2 transition-all w-full sm:w-auto"><Icons.PlusCircle /> Crear Propio</button>
                            </div>
                            <div className="absolute top-0 right-0 -mr-16 -mt-16 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl pointer-events-none"></div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                            {filtered.map(ind => {
                                const isActive = activeIds.includes(ind.id);
                                return (
                                    <div key={ind.id} onClick={() => toggleIndicator(ind.id)} className={`p-5 md:p-6 rounded-2xl border-2 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-1 bg-white relative group flex flex-col justify-between ${isActive ? 'border-cyan-500 shadow-cyan-100' : 'border-slate-200'}`}>
                                        <div>
                                            <div className="flex justify-between items-start mb-3">
                                                <Badge text={ind.type} type={ind.type}/>
                                                <div className={`w-6 h-6 rounded-full flex items-center justify-center transition-colors shrink-0 ${isActive ? 'bg-cyan-500 text-white' : 'bg-slate-100 text-slate-300'}`}><Icons.Check/></div>
                                            </div>
                                            <h3 className={`font-bold text-lg mb-2 transition-colors leading-tight break-words ${isActive ? 'text-slate-900' : 'text-slate-700'}`}>{ind.name}</h3>
                                            <p className="text-sm text-slate-500">{ind.desc}</p>
                                        </div>
                                        <div className="mt-4 pt-3 border-t border-slate-100 text-xs text-slate-400 flex justify-between font-mono"><span>{ind.function}</span><span>{ind.source}</span></div>
                                        
                                        {ind.source === 'Personalizado' && (
                                            <div className="absolute bottom-3 right-4 flex gap-1">
                                                <button onClick={(e)=>editCustomIndicator(e, ind)} className="p-1.5 text-slate-300 hover:text-cyan-500 transition-colors" title="Editar Indicador"><Icons.Edit/></button>
                                                <button onClick={(e)=>deleteCustom(e, ind.id)} className="p-1.5 text-slate-300 hover:text-rose-500 transition-colors" title="Eliminar Indicador"><Icons.Trash/></button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const CreatorView = () => {
                const editingInd = editingIndId ? customLibrary.find(i => i.id === editingIndId) : null;
                const [showHelp, setShowHelp] = useState(false); 

                const [form, setForm] = useState({ 
                    name: editingInd ? editingInd.name : '', 
                    type: editingInd ? editingInd.type : 'Proactivo', 
                    level: editingInd ? editingInd.level : 'Táctico', 
                    function: editingInd ? editingInd.function : 'Seguridad', 
                    unit: editingInd ? editingInd.unit : '%', 
                    calc: editingInd ? editingInd.calc : 'percentage', 
                    target: editingInd ? editingInd.target : 90, 
                    desc: editingInd ? editingInd.desc : '', 
                    help_what: editingInd ? editingInd.help?.what : '', 
                    help_why: editingInd ? editingInd.help?.why : '', 
                    help_labelNum: editingInd ? editingInd.help?.labelNum : 'Numerador', 
                    help_labelDen: editingInd ? editingInd.help?.labelDen : 'Denominador', 
                    help_example: editingInd ? editingInd.help?.example : '' 
                });

                useEffect(() => {
                    return () => setEditingIndId(null);
                }, []);

                const handleCreate = (e) => {
                    e.preventDefault();
                    const newInd = {
                        id: editingInd ? editingInd.id : `PRO-${Date.now().toString().slice(-4)}`, 
                        source: 'Personalizado', name: form.name, type: form.type, level: form.level, function: form.function, unit: form.unit, calc: form.calc, target: form.target, desc: form.desc,
                        help: { what: form.help_what || form.desc, why: form.help_why || 'Importante para la gestión.', labelNum: form.help_labelNum, labelDen: form.help_labelDen, example: form.help_example || '-' }
                    };
                    
                    if (editingInd) {
                        setCustomLibrary(customLibrary.map(i => i.id === editingInd.id ? newInd : i));
                        showToast("Indicador personalizado actualizado");
                    } else {
                        setCustomLibrary([...customLibrary, newInd]);
                        setActiveIds([...activeIds, newInd.id]);
                        showToast("Indicador personalizado creado y activado");
                    }
                    
                    setEditingIndId(null);
                    setView('library');
                };

                return (
                    <div className="max-w-4xl mx-auto animate-fade-in space-y-6">
                         <div className="flex items-center gap-4 mb-2">
                            <button onClick={() => { setEditingIndId(null); setView('library'); }} className="text-slate-500 hover:text-cyan-600 font-bold transition-colors">← Volver al Catálogo</button>
                            <h2 className="text-2xl font-bold font-outfit text-slate-900">{editingInd ? 'Editar Indicador Personalizado' : 'Crear Nuevo Indicador'}</h2>
                        </div>

                        {/* --- GUÍA METODOLÓGICA AMPLIADA (8 MÉTODOS) --- */}
                        <div className="mb-6">
                            <button
                                type="button"
                                onClick={() => setShowHelp(!showHelp)}
                                className="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-5 py-3 rounded-xl font-bold text-sm transition-colors border border-slate-300 w-full justify-center md:w-auto md:justify-start shadow-sm"
                            >
                                <Icons.BookOpen /> {showHelp ? 'Ocultar Guía Metodológica' : '📖 Abrir Guía Metodológica (Fórmulas y Conceptos)'}
                            </button>

                            {showHelp && (
                                <div className="mt-4 bg-slate-900 border border-slate-700 rounded-2xl p-6 md:p-8 shadow-xl animate-fade-in text-left">
                                    <h3 className="text-xl font-bold text-cyan-400 mb-6 flex items-center gap-2">
                                        <Icons.Lightbulb /> Guía de Creación de Indicadores SST
                                    </h3>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        {/* Columna 1: Tipos */}
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-white border-b border-slate-700 pb-2">1. Tipo de Indicador</h4>
                                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                                <p className="text-emerald-400 font-bold text-sm mb-1">Proactivo (Preventivo)</p>
                                                <p className="text-slate-300 text-xs">Mide las acciones hechas <strong>ANTES</strong> de que ocurra el daño. (Ej: Capacitaciones, Inspecciones). <br/><em className="text-emerald-400/80">Su meta suele ser alta (ej. 90% - 100%).</em></p>
                                            </div>
                                            <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                                                <p className="text-rose-400 font-bold text-sm mb-1">Reactivo (Consecuencia)</p>
                                                <p className="text-slate-300 text-xs">Mide el daño <strong>DESPUÉS</strong> de que ocurrió. (Ej: Accidentes, Días Perdidos, Costos). <br/><em className="text-rose-400/80">Su meta suele ser muy baja (ej. 0 o &lt; 2.5).</em></p>
                                            </div>
                                        </div>

                                        {/* Columna 2: Fórmulas (Ampliada a 8) */}
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-white border-b border-slate-700 pb-2">2. Métodos de Cálculo</h4>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Porcentaje (%)</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">(A / B) × 100</code>
                                                    <p className="italic text-[9px] text-slate-400 mt-1">Cumplimiento de metas (Topado a 100%).</p>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Tasa (Factor K)</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">(A / B) × K</code>
                                                    <p className="italic text-[9px] text-slate-400 mt-1">Accidentes x Millón de horas (LTIFR).</p>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Incidencia</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">(A / B) × 1000</code>
                                                    <p className="italic text-[9px] text-slate-400 mt-1">Casos por cada 1,000 trabajadores.</p>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Moneda / Costo</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">Valor de A</code>
                                                    <p className="italic text-[9px] text-slate-400 mt-1">Dinero gastado o presupuesto (B se ignora).</p>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Variación (%)</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">((A - B) / B) × 100</code>
                                                    <p className="italic text-[9px] text-slate-400 mt-1">Tendencia vs Mes anterior.</p>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Ratio (1:X)</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">B / A</code>
                                                    <p className="italic text-[9px] text-slate-400 mt-1">Ej: 1 Prevencionista por cada X Trab.</p>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Conteo (#)</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">Valor de A</code>
                                                </div>
                                                <div className="bg-slate-800/50 p-3 rounded-xl text-xs text-slate-300 border border-slate-700">
                                                    <span className="text-cyan-300 font-bold block mb-1">Promedio</span>
                                                    <code className="bg-slate-950 px-1 py-0.5 rounded text-cyan-100">A / B</code>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Columna 3: Inputs */}
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-white border-b border-slate-700 pb-2">3. Anatomía del Dato</h4>
                                            <div className="bg-cyan-900/20 border border-cyan-800/50 p-4 rounded-xl">
                                                <p className="text-cyan-300 font-bold text-sm mb-1">A. Numerador (Dato Principal)</p>
                                                <p className="text-slate-300 text-xs mb-4">El valor real medido, o el dato del "Mes Actual" si es una variación.<br/><span className="text-cyan-100/70 italic">Ej: Capacitaciones dictadas, N° de accidentes, Gastos ($).</span></p>
                                                
                                                <p className="text-cyan-300 font-bold text-sm mb-1">B. Denominador (Base/Universo)</p>
                                                <p className="text-slate-300 text-xs mb-4">El total posible, expuestos, o el dato del "Mes Anterior" si es variación.<br/><span className="text-cyan-100/70 italic">Ej: Total de trabajadores, Horas Hombre (HHT).</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        {/* --- FIN GUÍA METODOLÓGICA --- */}

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                            <Card className="p-6 md:p-8 border-t-4 border-t-slate-800">
                                <h3 className="text-sm font-bold text-slate-500 uppercase mb-4 border-b border-slate-100 pb-2">1. Configuración Técnica</h3>
                                <form id="creator-form" onSubmit={handleCreate} className="space-y-4">
                                    <div><label className="text-xs font-bold text-slate-600 block mb-1">Nombre</label><input required className="input-field font-bold" value={form.name} onChange={e=>setForm({...form, name: e.target.value})} placeholder="Ej. Tasa de Cierre de Hallazgos" /></div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-slate-600 block mb-1">Tipo</label><select className="input-field" value={form.type} onChange={e=>setForm({...form, type: e.target.value})}><option>Proactivo</option><option>Reactivo</option></select></div>
                                        
                                        {/* --- NUEVAS OPCIONES DE CÁLCULO EN EL SELECTOR --- */}
                                        <div><label className="text-xs font-bold text-slate-600 block mb-1">Cálculo</label>
                                            <select className="input-field" value={form.calc} onChange={e=>setForm({...form, calc: e.target.value})}>
                                                <option value="percentage">Porcentaje (%)</option>
                                                <option value="rate">Tasa (Factor K)</option>
                                                <option value="incidence">Incidencia (x 1,000)</option>
                                                <option value="currency">Moneda / Costo ($)</option>
                                                <option value="variation">Variación Tendencia (%)</option>
                                                <option value="ratio">Ratio / Proporción (1:X)</option>
                                                <option value="count">Conteo Directo (#)</option>
                                                <option value="average">Promedio Simple</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div><label className="text-xs font-bold text-slate-600 block mb-1">Meta</label><input type="number" step="0.01" className="input-field" value={form.target} onChange={e=>setForm({...form, target: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-600 block mb-1">Descripción</label><textarea className="input-field" rows="2" value={form.desc} onChange={e=>setForm({...form, desc: e.target.value})} placeholder="Breve descripción del indicador..."></textarea></div>
                                </form>
                            </Card>
                            <Card className="p-6 md:p-8 bg-slate-900 text-white border-slate-800 shadow-xl shadow-cyan-900/10">
                                <h3 className="text-sm font-bold text-cyan-400 uppercase mb-4 border-b border-slate-700 pb-2 flex items-center gap-2"><Icons.Lightbulb /> 2. Profesor Virtual (Ayuda)</h3>
                                <div className="space-y-4">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        <div><label className="text-xs font-bold text-slate-400 block mb-1">A. Etiqueta Num.</label><input className="input-field bg-slate-800 border-slate-600 text-white text-sm focus:border-cyan-500" value={form.help_labelNum} onChange={e=>setForm({...form, help_labelNum: e.target.value})} /></div>
                                        <div><label className="text-xs font-bold text-slate-400 block mb-1">B. Etiqueta Den.</label><input className="input-field bg-slate-800 border-slate-600 text-white text-sm focus:border-cyan-500" value={form.help_labelDen} onChange={e=>setForm({...form, help_labelDen: e.target.value})} /></div>
                                    </div>
                                    <div><label className="text-xs font-bold text-slate-400 block mb-1">¿Qué es esto?</label><textarea className="input-field bg-slate-800 border-slate-600 text-white text-sm focus:border-cyan-500" rows="1" value={form.help_what} onChange={e=>setForm({...form, help_what: e.target.value})}></textarea></div>
                                    <div><label className="text-xs font-bold text-slate-400 block mb-1">¿Por qué importa?</label><textarea className="input-field bg-slate-800 border-slate-600 text-white text-sm focus:border-cyan-500" rows="1" value={form.help_why} onChange={e=>setForm({...form, help_why: e.target.value})}></textarea></div>
                                    <button type="submit" form="creator-form" className="w-full mt-6 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-cyan-500/30 transition-all hover:-translate-y-0.5">
                                        {editingInd ? 'Guardar Cambios' : 'Guardar Indicador'}
                                    </button>
                                </div>
                            </Card>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex flex-col font-outfit text-slate-800 pb-20">
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm no-print">
                        <div className="max-w-7xl mx-auto px-4 md:px-6 h-auto md:h-24 py-3 flex flex-wrap md:flex-nowrap items-center justify-between gap-3">
                            <div className="flex items-center gap-3 md:gap-4 shrink-0">
                                <img src="https://assets.poap.xyz/04118473-016e-4c9a-83b6-6ae33fbbfd8f.png" alt="Academia Movida SST" className="w-12 h-12 md:w-20 md:h-20 object-contain drop-shadow-[0_0_15px_rgba(6,182,212,0.4)] rounded-full border border-cyan-500/20" />
                                <div>
                                    <h1 className="font-extrabold text-lg md:text-2xl tracking-tight text-slate-900 leading-none mb-1">Academia Movida SST</h1>
                                    <span className="text-[9px] md:text-xs font-bold text-cyan-600 tracking-widest uppercase bg-cyan-50 px-2 py-0.5 rounded border border-cyan-100">Indicadores de gestión</span>
                                </div>
                            </div>

                            <div className="flex items-center flex-wrap md:flex-nowrap gap-2 md:gap-4 w-full md:w-auto justify-end">
                                <div className="hidden lg:flex bg-slate-100 p-1.5 rounded-xl border border-slate-200">
                                    {[{id:'library',l:'1. Catálogo'},{id:'input',l:'2. Datos'},{id:'dashboard',l:'3. Tablero'}].map(i=>(
                                        <button key={i.id} onClick={()=>setView(i.id)} className={`px-5 py-2.5 rounded-lg text-sm font-bold transition-all ${view===i.id?'bg-white text-cyan-700 shadow-md border border-slate-200':'text-slate-500 hover:text-slate-900 hover:bg-slate-200/50'}`}>{i.l}</button>
                                    ))}
                                </div>
                                <div className="flex lg:hidden bg-slate-100 p-1 rounded-lg border border-slate-200 w-full justify-between">
                                    {[{id:'library',l:'Catálogo'},{id:'input',l:'Datos'},{id:'dashboard',l:'Tablero'}].map(i=>(
                                        <button key={i.id} onClick={()=>setView(i.id)} className={`flex-1 px-2 py-2 rounded-md text-xs sm:text-sm font-bold text-center ${view===i.id?'bg-white text-cyan-600 shadow border border-slate-200':'text-slate-500'}`}>{i.l}</button>
                                    ))}
                                </div>
                                <div className="flex items-center gap-1 md:border-l md:border-slate-200 md:pl-4">
                                    <button onClick={loadDemoData} title="Cargar Demo" className="p-2.5 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-xl transition-all shadow-sm font-bold flex items-center gap-1.5 border border-indigo-100"><Icons.Play/></button>
                                    <button onClick={resetData} title="Borrar Todo" className="p-2.5 bg-rose-50 text-rose-600 hover:bg-rose-100 rounded-xl transition-all shadow-sm font-bold flex items-center gap-1.5 border border-rose-100"><Icons.Refresh/></button>
                                    <button onClick={() => setShowSettings(true)} title="Configuración" className="p-2.5 bg-slate-900 text-cyan-400 hover:bg-slate-800 rounded-xl transition-all shadow-lg ml-1"><Icons.Settings/></button>
                                    <a href="https://movidasst.org/login/index.php" target="_blank" rel="noopener noreferrer" className="ml-1 hidden xl:flex items-center gap-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 text-white px-4 py-2.5 rounded-xl font-bold text-sm shadow-md transition-all border border-cyan-400/30 whitespace-nowrap">
                                        Ir a Academia <Icons.ExternalLink />
                                    </a>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-grow p-4 md:p-8 max-w-7xl w-full mx-auto relative z-10">
                        <div className="print-only hidden mb-8 border-b-2 border-cyan-600 pb-4">
                            <h1 className="text-3xl font-extrabold text-slate-900">Indicadores de gestión de SST</h1>
                            <p className="text-slate-500 font-bold mt-1">Academia Movida SST - Informe de Desempeño</p>
                        </div>
                        {view === 'library' && <LibraryView />}
                        {view === 'create' && <CreatorView />}
                        {view === 'input' && <InputView />}
                        {view === 'dashboard' && <DashboardView />}
                    </main>

                    {/* Modales y Alertas UI */}
                    <ImportModal />
                    <EditRecordModal />
                    
                    {modalConfig.isOpen && (
                        <div className="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[80] flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl shadow-cyan-900/20 p-6 w-full max-w-sm text-center transform scale-100 transition-all">
                                <div className="flex justify-center mb-4">
                                    {modalConfig.isAlert ? <div className="p-3 bg-rose-500/20 text-rose-400 rounded-full"><Icons.AlertCircle /></div> : <div className="p-3 bg-cyan-500/20 text-cyan-400 rounded-full"><Icons.Lightbulb /></div>}
                                </div>
                                <h2 className="text-xl font-bold mb-2 text-white">{modalConfig.title}</h2>
                                <p className="text-slate-400 mb-6 text-sm">{modalConfig.message}</p>
                                <div className="flex flex-col sm:flex-row justify-center gap-3">
                                    {!modalConfig.isAlert && <button onClick={closeModal} className="px-5 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl font-bold transition-colors w-full">Cancelar</button>}
                                    <button onClick={() => { if(modalConfig.onConfirm) modalConfig.onConfirm(); closeModal(); }} className={`px-5 py-2.5 rounded-xl font-bold transition-colors w-full text-white ${modalConfig.isAlert ? 'bg-rose-600 hover:bg-rose-500' : 'bg-cyan-600 hover:bg-cyan-500'}`}>Aceptar</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <Toast message={toastMsg} onClose={() => setToastMsg('')} />
                    <SettingsModal />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
